<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>microN2T</title>
    <!--
        Provides a web interface for microN2T.

        This code is experimental and likely to change significantly.
    -->
    <link rel="stylesheet" href="./css/main.css" />
    <script type="module">
        import {GhCorner} from "./js/main.js";
        
        const META_HEADER = {"Accept":"application/json;profile=https://rslv.xyz/info"};

        function selectPrefix(pfx) {
            return {
                pfx:pfx,
                name: `Test: ${pfx}`,
            };
        }

        const prefixSource = "https://rslv.deta.dev/";
        //const prefixSource = "http://localhost:8000/";
        let allPrefixes = [];

        globalThis.data = {
            pfx: "",
            resolver: prefixSource, 
            prefix: {
                pfx:"",
                name:""
            },
            makeSuggestion: function (e){
                console.log(this.pfx);
                const _url = `${prefixSource}${this.pfx}`;
                console.log("_url", _url);
                fetch(_url, {headers:META_HEADER}).then(response => {return response.json()})
                  .then(p => {
                      this.prefix = p;
                      console.log(this.prefix);
                  })
                //this.prefix = selectPrefix(this.pfx);
            }
        };

        fetch(prefixSource)
        .then((response)=>{return response.json()})
        .then((data)=> {
            const datalist = document.getElementById("prefix_list");
            data.forEach(element => {
                allPrefixes.push(element);
                const opt = document.createElement('option');
                opt.value = element;
                datalist.append(opt);
            })
            //for (let i=0; i < data.length; i++) {
            //    allPrefixes.push({text:data[i], value:data[i]})
            //};
            //const ele = document.getElementById("prefix_entry");
            //ele.fulllist = allPrefixes;
            Alpine.start();            
        })
    </script>

</head>
<body>
    <header>
        <gh-corner user="CDLUC3" repo="N2T"></gh-corner>        
        <h1>microN2T</h1>
    </header>
    <section x-data="data" x-init="$watch('pfx', value => makeSuggestion())">
        <input 
            type="text" 
            id="prefix2" 
            list="prefix_list" 
            placeholder="Pick a prefix..." 
            x-model.lazy="pfx"             
            />
        <datalist id="prefix_list"></datalist>
        <dl>
            <dt>pfx</dt><dd x-text="pfx">Loading...</dd>
            <dt>name</dt><dd x-text="prefix.name"></dd>
            <dt>type</dt><dd x-text="prefix.type"></dd>
            <dt>redirect</dt><dd x-text="prefix.redirect"></dd>
            <dt>pattern</dt><dd x-text="prefix.pattern"></dd>
            <dt>test</dt><dd><a target="_blank" x-bind:href="`${resolver}${pfx}:${prefix.test}`" x-text="prefix.test"></a></dd>
            <dt>description</dt><dd x-text="prefix.description"></dd>
        </dl>
    </section>
    <footer>        
    </footer>
</body>
</html>
